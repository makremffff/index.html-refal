<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>iPhone 14 Pro – 6 أزرار 3D Puch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#111;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display",Helvetica,Arial,sans-serif;
    }
    .phone{
      position:relative;
      width:min(390px, 90vw);
      aspect-ratio:9/17.55;
      background:#000;
      border-radius:47px;
      box-shadow:0 0 0 2px #333, 0 0 0 4px #000, 0 25px 50px -10px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .island{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      width:126px;
      height:37px;
      background:#000;
      border-radius:20px;
      z-index:3;
    }
    .screen{
      position:absolute;
      inset:3px;
      background:#1a1a1a;
      border-radius:44px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      align-items:center;
      padding-bottom:20px;
    }
    .btn-row{
      display:flex;
      gap:12px;
      margin-bottom:12px;
    }
    .btn{
      width:40px;
      height:40px;
      border-radius:12px;
      background:linear-gradient(145deg, #c62c2c, #8a1b1b);
      box-shadow:
        6px 6px 12px #0f0f0f,
        -6px -6px 12px #3b3b3b,
        inset 0 0 0 #000;
      transition:.15s;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:10px;
      font-weight:600;
      text-align:center;
      user-select:none;
      padding:2px;
    }
    .btn:active{
      box-shadow:
        inset 6px 6px 12px #0f0f0f,
        inset -6px -6px 12px #3b3b3b;
      transform:scale(.96);
    }
    .page{
      position:absolute;
      inset:0;
      background:#000;
      display:none;
    }
    .page.active{display:flex;flex-direction:column}
    .back{
      position:absolute;
      top:20px;
      left:20px;
      background:#c62c2c;
      border:none;
      color:#fff;
      padding:8px 16px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
    }
    .user-img{
      position:absolute;
      top:calc(20px + 15vh);
      left:20px;
      width:40px;
      height:40px;
      border-radius:50%;
      border:2px solid #c62c2c;
      object-fit:cover;
      z-index:10;
    }
    #referral-page{
      padding:20px;
      color:#fff;
      font-size:17px;
      flex:1;
      overflow:auto;
    }
    #referral-page h2{
      text-align:center;
      margin-bottom:20px;
    }
    #ref_link{
      display:inline-block;
      background:#111;
      padding:10px;
      border-radius:10px;
      color:#0f0;
      word-break:break-all;
      width:100%;
    }
    #copy_ref{
      margin-top:10px;
      padding:10px;
      width:100%;
      border-radius:12px;
      background:#333;
      color:white;
      border:none;
      font-size:16px;
      cursor:pointer;
    }
    #ref_list>div{
      padding:8px 0;
      border-bottom:1px solid #444;
    }
  </style>
</head>
<body>
  <div class="phone">
    <img class="user-img" id="userImg" style="display:none" alt>
    <div class="island"></div>

    <div class="screen active" id="home">
      <div class="btn-row">
        <div class="btn" onclick="showPage('withdraw')">Withdraw</div>
        <div class="btn" onclick="showPage('task')">Task</div>
        <div class="btn" onclick="alert('ADS action')">Ads</div>
        <div class="btn" onclick="showPage('swap')">Swap</div>
        <div class="btn" onclick="showPage('ledbord')">Ledbord</div>
        <div class="btn" onclick="showPage('refal')">Refal</div>
      </div>
    </div>

    <div class="page" id="withdraw"><button class="back" onclick="showPage('home')">Back</button></div>
    <div class="page" id="task"><button class="back" onclick="showPage('home')">Back</button></div>
    <div class="page" id="swap"><button class="back" onclick="showPage('home')">Back</button></div>
    <div class="page" id="ledbord"><button class="back" onclick="showPage('home')">Back</button></div>

    <div class="page" id="refal">
      <button class="back" onclick="showPage('home')">Back</button>
      <div id="referral-page">
        <h2>نظام الإحالات</h2>
        <div style="margin-top:20px">
          <p><b>اسمك:</b> <span id="ref_name"></span></p>
          <p><b>معرفك:</b> <span id="ref_id"></span></p>
          <p style="margin-top:15px"><b>رابط الإحالة:</b></p>
          <div><span id="ref_link"></span></div>
          <button id="copy_ref">نسخ الرابط</button>
          <div style="margin-top:20px">
            <p><b>عدد الإحالات:</b> <span id="ref_count">0</span></p>
            <p><b>نقاط من الإحالات:</b> <span id="ref_earn">0</span></p>
          </div>
          <h3 style="margin-top:20px">المحيلون:</h3>
          <div id="ref_list">لا يوجد إحالات حتى الآن</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import {createClient} from "https://esm.sh/@supabase/supabase-js";
    const SUP_URL="https://imfuyjjafehklggmnigh.supabase.co";
    const SUP_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZnV5amphZmVoa2xnZ21uaWdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNTAxOTYsImV4cCI6MjA3ODYyNjE5Nn0.z-eMhubK5OUOPHTaDnwtVuQiu_K55wYO_WPzoko0vVg";
    const supa=createClient(SUP_URL,SUP_KEY);
    const tg=window.Telegram.WebApp;
    try{tg.expand()}catch(e){console.warn("TG not detected")}

    let tgUser=null;
    let refId=null; // referrer id from start_param

    window.showPage=id=>{
      document.querySelectorAll('.page,.screen').forEach(el=>el.classList.remove('active'));
      if(id==='home') document.getElementById('home').classList.add('active');
      else{
        const pg=document.getElementById(id);
        if(pg) pg.classList.add('active');
        if(id==='refal') loadRef();
      }
    };

    async function registerUser(){
      if(!tgUser) return;
      const {data:ex}=await supa.from('players').select('id').eq('user_id',tgUser.id).single();
      if(!ex){
        const payload={
          user_id:tgUser.id,
          first_name:tgUser.first_name||'',
          last_name:tgUser.last_name||'',
          username:tgUser.username||'',
          referred_by:refId||null,
          points:100 // basic points
        };
        await supa.from('players').insert(payload);
      }
    }

    async function loadTelegram(){
      const raw=localStorage.getItem('telegramUser');
      if(raw){
        try{
          tgUser=JSON.parse(raw);
          if(tgUser.photo_url){
            document.getElementById('userImg').src=tgUser.photo_url;
            document.getElementById('userImg').style.display='block';
          }
        }catch(e){}
      }
      // fallback without telegram
      if(!tgUser){
        tgUser={
          id:localStorage.getItem('fallbackId')||String(Date.now()+Math.floor(Math.random()*1e6)),
          first_name:'لاعب',
          last_name:'',
          username:'',
          photo_url:''
        };
        localStorage.setItem('fallbackId',tgUser.id);
        localStorage.setItem('telegramUser',JSON.stringify(tgUser));
      }

      // read start_param (referrer)
      if(tg?.initDataUnsafe?.start_param){
        const m=tg.initDataUnsafe.start_param.match(/^ref_(\d+)$/);
        if(m) refId=Number(m[1]);
      }

      // real telegram user
      if(tg?.initDataUnsafe?.user){
        tgUser=tg.initDataUnsafe.user;
        localStorage.setItem('telegramUser',JSON.stringify(tgUser));
        if(tgUser.photo_url){
          document.getElementById('userImg').src=tgUser.photo_url;
          document.getElementById('userImg').style.display='block';
        }
      }

      await registerUser();
    }

    async function loadRef(){
      if(!tgUser) return;
      document.getElementById('ref_name').textContent=tgUser.first_name||'لاعب';
      document.getElementById('ref_id').textContent=tgUser.id;

      const refLink=`https://t.me/Game_win_usdtBot/earn?startapp=ref_${tgUser.id}`;
      document.getElementById('ref_link').textContent=refLink;

      document.getElementById('copy_ref').onclick=()=>{
        navigator.clipboard.writeText(refLink).then(()=>{
          try{tg.showAlert('تم نسخ رابط الإحالة')}catch(e){alert('تم النسخ')}
        });
      };

      const {data,error}=await supa.from('players').select('*').eq('referred_by',tgUser.id);
      if(error){console.error(error);return}
      const count=data.length;
      document.getElementById('ref_count').textContent=count;
      document.getElementById('ref_earn').textContent=count*10;
      let html='';
      data.forEach(p=>{
        html+=`<div>${p.first_name||'مستخدم'} — ID: ${p.user_id}</div>`;
      });
      document.getElementById('ref_list').innerHTML=html||'لا يوجد إحالات حتى الآن';
    }

    document.addEventListener('DOMContentLoaded',()=>{
      loadTelegram().then(()=> showPage('home'));
    });
  </script>
</body>
</html>
